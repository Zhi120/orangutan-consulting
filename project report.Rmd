---
title: "Consulting Project Report"
author: "Xiaohan Shi, Zihao Zhang, Suheng Yao"
date: "2024-11-16"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(glmmTMB)
library(lme4)
```

```{r}
# Read in the data
df_score <- read.csv("diversity_score.csv")
df_sex <- read.csv("diversity_score_withsex.csv")
```

# Introduction

Our group's project is on the positional behaviors of orangutans. Orangutans are primates that live in the rain forests of Southeast Asia and are known for their red fur and high intelligence. They are also the largest arboreal mammals living in the world. They are found mainly in Borneo and Sumatra and are listed as an endangered species due to habitat loss and threats from illegal hunting. The main objective of this consulting project is to help the client analyze the positional behaviors of orangutans over developmental stages to understand how these behaviors evolve with age. The client used a measurement called Shannor Weaver Index to calculate the diversity score based on the positional behavior and try to find its relationship with age. How Shannor Weaver Index is calculated will be covered more in the method part of the report.

The original data that the client gave us contains 237 individual orangutans that had been followed for 30 years at different periods.
Each orangutan was observed for a period of time at different times, and the timing of the behavior at each location was recorded. In total, there are 77 unique positional behaviors recorded for each orangutan. These behaviors are created by the combination of three behavior groups: activity type, body position, and tree position.

In this report, we will mainly talk about the basic EDA to analyze the data, the methods used to assess the relationship, including the models used, and finally the conclusion based on the results.

# Method
## How does Shannon Weaver Index calculate?

The formula is shown below:
$H' = -\sum_{i=1}^{S} p_i \ln(p_i)$
In this formula, S represents the number of unique categories in the data, $p_i$ is the proportion, which in the client's data refers to the proportion of recorded time of each distinct behaviors of a specific orangutan in relation to this orangutan's total minutes of awake.

## Data Cleaning on Diversity Score with Sex Dataset
```{r}
df_sex$Sex <- gsub("M?", "M", df_sex$Sex, fixed = TRUE)
df_sex <- df_sex[!df_sex$Sex %in% c("?", "Q"), ]
unique(df_sex$Sex)
```
```{r}
ggplot() +
  geom_point(data=df_sex, aes(x=as.factor(Age), y=DiversityScore, fill=Sex, color=Sex), size = 0.75, shape = 1, position = position_jitterdodge()) +
  geom_boxplot(data=df_sex, aes(x=as.factor(Age), y=DiversityScore, color=Sex), alpha = 0.6) +
  theme_classic()
```


## Comparing the Model3's Performance to Other Model
```{r}
# Original Model
model.31 <- glmmTMB(data=df_score, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
summary(model.31)

# Try original model adding random slope for Age
model.6 <- glmmTMB(
  data = df_score,
  DiversityScore ~ Age + I(Age^2) + 
    (1 + Age| Name) + 
    (1 | FollowNumber),
  family = gaussian(link = "log")
)
summary(model.6)
anova(model.31, model.6)
```
```{r}
# Try original model without gaussian log link
model.31 <- glmmTMB(data=df_score, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber))
summary(model.31)

# Try Linear Mixed Model
model_linear <- lmer(
  DiversityScore ~ Age + I(Age^2) + 
    (1 | Name) + (1 | FollowNumber),
  data = df_score)
```

## Prediction check
```{r}
#run the model
model.3 <- glmmTMB(data=df_score, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))

# get model predictions (include random effect)
predicted_values <- predict(model.3, type = "response")

# actual values
actual_values <- df_score$DiversityScore

# MSE
MSE <- mean((actual_values - predicted_values)^2)
print(MSE)

# use R-square
library(performance)
r2 <- r2(model.3)
print(r2)

#using plot
ggplot(df_score, aes(x = actual_values, y = predicted_values)) +
  geom_point(alpha = 0.6, color = "blue") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  labs(title = "Actual vs Predicted DiversityScore",
       x = "Actual DiversityScore",
       y = "Predicted DiversityScore") +
  theme_minimal()
```

```{r}
# Model Fitting using glmer
df_score$log_diversity <- log(df_score$DiversityScore)
model.32 <- glmer(data=df_score, log_diversity ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber))
summary(model.32)
```
Fitting the same function in glmer will cause error, saying "did not converge".

```{r}
model.1 <- glmmTMB(data=df_score, DiversityScore ~  (1|Name) + (1|FollowNumber), family=gaussian(link="log"))
summary_df <- data.frame(Model_Type=c('Gaussian Log No F.E.'), AIC=summary(model.1)$AIC[1], BIC=summary(model.1)$AIC[2])

model.2 <- glmmTMB(data=df_score, DiversityScore ~ Age + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
summary_df[nrow(summary_df) + 1,] = c('Gaussian Log', summary(model.2)$AIC[1], summary(model.2)$AIC[2])

model.3 <- glmmTMB(data=df_score, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
summary_df[nrow(summary_df) + 1,] = c('Gaussian Log Age^2', summary(model.3)$AIC[1], summary(model.3)$AIC[2])

anova(model.1,model.2)
anova(model.2,model.3)



```

```{r}
residuals_model <- residuals(model.1, type = "pearson")

# Plot histogram of residuals
hist(residuals_model, main = "Histogram of Residuals", xlab = "Residuals")

# Q-Q plot to check normality
qqnorm(residuals_model)
qqline(residuals_model, col = "red")

fitted_values <- fitted(model.1)

# Plot residuals vs fitted values
plot(fitted_values, residuals_model, main = "Residuals vs Fitted Values",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
```

```{r}
residuals_model <- residuals(model.2, type = "pearson")

# Plot histogram of residuals
hist(residuals_model, main = "Histogram of Residuals", xlab = "Residuals")

# Q-Q plot to check normality
qqnorm(residuals_model)
qqline(residuals_model, col = "red")

fitted_values <- fitted(model.2)

# Plot residuals vs fitted values
plot(fitted_values, residuals_model, main = "Residuals vs Fitted Values",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
```

```{r}
residuals_model <- residuals(model.3, type = "pearson")

# Plot histogram of residuals
hist(residuals_model, main = "Histogram of Residuals", xlab = "Residuals")

# Q-Q plot to check normality
qqnorm(residuals_model)
qqline(residuals_model, col = "red")

fitted_values <- fitted(model.3)

# Plot residuals vs fitted values
plot(fitted_values, residuals_model, main = "Residuals vs Fitted Values",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
```


