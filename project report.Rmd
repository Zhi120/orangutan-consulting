---
title: "Consulting Project Report"
author: "Xiaohan Shi, Zihao Zhang, Suheng Yao"
date: "2024-11-16"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(glmmTMB)
library(lme4)
library(caret)
```


```{r}
# Read in the data
df_score <- read.csv("diversity_score.csv")
df_sex <- read.csv("diversity_score_withsex.csv")
```


# Introduction

Our group's project is on the positional behaviors of orangutans. Orangutans are primates that live in the rain forests of Southeast Asia and are known for their red fur and high intelligence. They are also the largest arboreal mammals living in the world. They are found mainly in Borneo and Sumatra and are listed as an endangered species due to habitat loss and threats from illegal hunting. The main objective of this consulting project is to help the client analyze the positional behaviors of orangutans over developmental stages to understand how these behaviors evolve with age. The client used a measurement called Shannor Weaver Index to calculate the diversity score based on the positional behavior and try to find its relationship with age. How Shannor Weaver Index is calculated will be covered more in the method part of the report.

The original data that the client gave us contains 237 individual orangutans that had been followed for 30 years at different periods.
Each orangutan was observed for a period of time at different times, and the timing of the behavior at each location was recorded. In total, there are 77 unique positional behaviors recorded for each orangutan. These behaviors are created by the combination of three behavior groups: activity type, body position, and tree position.

In this report, we will mainly talk about the basic EDA to analyze the data, the methods used to assess the relationship, including the models used, and finally the conclusion based on the results.

# Method
## How does Shannon Weaver Index calculate?

The formula is shown below:
$H' = -\sum_{i=1}^{S} p_i \ln(p_i)$
In this formula, S represents the number of unique categories in the data, $p_i$ is the proportion, which in the client's data refers to the proportion of recorded time of each distinct behaviors of a specific orangutan in relation to this orangutan's total minutes of awake.

## Data Cleaning on Diversity Score with Sex Dataset
```{r}
df_sex$Sex <- gsub("M?", "M", df_sex$Sex, fixed = TRUE)
df_sex <- df_sex[!df_sex$Sex %in% c("?", "Q"), ]
unique(df_sex$Sex)
```
```{r}
library(ggplot2)
ggplot() +
  geom_point(data=df_sex, aes(x=as.factor(Age), y=DiversityScore, fill=Sex, color=Sex), size = 0.75, shape = 1, position = position_jitterdodge()) +
  geom_boxplot(data=df_sex, aes(x=as.factor(Age), y=DiversityScore, color=Sex), alpha = 0.6) +
  theme_classic()
```

## Client Models

Following client suggestions, we would like to use linear mixed effect models and build upon client's models and see if we improve the client's models. Initial client models are listed below:
```{r}
model.1 <- glmmTMB(data=df_score, DiversityScore ~  (1|Name) + (1|FollowNumber), family=gaussian(link="log"))

model.2 <- glmmTMB(data=df_score, DiversityScore ~ Age + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))

model.3 <- glmmTMB(data=df_score, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
```


## Check Client's Model Assumptions

We first need to check all the linear assumptions are met:
```{r}
residuals_model <- residuals(model.1, type = "pearson")

# Plot histogram of residuals
hist(residuals_model, main = "Histogram of Residuals", xlab = "Residuals")

# Q-Q plot to check normality
qqnorm(residuals_model)
qqline(residuals_model, col = "red")

fitted_values <- fitted(model.1)

# Plot residuals vs fitted values
plot(fitted_values, residuals_model, main = "Residuals vs Fitted Values",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
```

```{r}
residuals_model <- residuals(model.2, type = "pearson")

# Plot histogram of residuals
hist(residuals_model, main = "Histogram of Residuals", xlab = "Residuals")

# Q-Q plot to check normality
qqnorm(residuals_model)
qqline(residuals_model, col = "red")

fitted_values <- fitted(model.2)

# Plot residuals vs fitted values
plot(fitted_values, residuals_model, main = "Residuals vs Fitted Values",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
```

```{r}
residuals_model <- residuals(model.3, type = "pearson")

# Plot histogram of residuals
hist(residuals_model, main = "Histogram of Residuals", xlab = "Residuals")

# Q-Q plot to check normality
qqnorm(residuals_model)
qqline(residuals_model, col = "red")

fitted_values <- fitted(model.3)

# Plot residuals vs fitted values
plot(fitted_values, residuals_model, main = "Residuals vs Fitted Values",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
```
Based on the assumptions check above, all three models have normal distributed residuals, no-heavy tails in qq plot and random distribution in residual vs fitted plot, indicating that all the models satisfy linear assumptions.

## Compare Client's Model with Our Model

Here we propose three new models building upon the client models:
```{r}
df_score$Age <- as.factor(df_score$Age)

model.1 <- glmmTMB(data=df_sex, DiversityScore ~ Sex+ (1|Name) + (1|FollowNumber), family=gaussian(link="log"))
summary_df <- data.frame(Model_Type=c('Gaussian Log No F.E.'), AIC=summary(model.1)$AIC[1], BIC=summary(model.1)$AIC[2])

model.2 <- glmmTMB(data=df_sex, DiversityScore ~ Age + Sex+ (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
summary_df[nrow(summary_df) + 1,] = c('Gaussian Log', summary(model.2)$AIC[1], summary(model.2)$AIC[2])

model.6 <- glmmTMB(
  data = df_sex,
  DiversityScore ~ Age  + Sex+
    (1 + Age| Name) + 
    (1 | FollowNumber),
  family = gaussian(link = "log")
)


anova(model.1,model.2)
anova(model.2,model.6)

```
Based on the chi-square test results, since the p-value for the chi-square test in less than 0.05, indicating that the model 6 with random slope for age is the best model. We will check for the model's performance in the next section.


## Model 6 Performance

To check for the performance of the model, we propose to use k-fold cross validation:
```{r}
# Custom function to fit models
fit_glmmTMB <- function(train_data, test_data) {
  model <- glmmTMB(
    data = train_data,
    DiversityScore ~ Age + Sex +
      (1 + Age | Name) +
      (1 | FollowNumber),
    family = gaussian(link = "log")
  )
  
  predictions <- predict(model, newdata = test_data, 
                         allow.new.levels = TRUE, type = "response")
  rmse_value <- sqrt(mean((test_data$DiversityScore - predictions)^2))
  
  return(rmse_value)
}

# Split data into 5 folds
set.seed(724)  # For reproducibility
folds <- createFolds(df_sex$DiversityScore, k = 5, list = TRUE)

cv_results <- sapply(folds, function(test_indices) {
  test_data <- df_sex[test_indices, ]
  train_data <- df_sex[-test_indices, ]
  
  fit_glmmTMB(train_data, test_data)
})

# Calculate average RMSE across folds
mean_rmse <- mean(cv_results)
cat("Average RMSE across folds:", mean_rmse, "\n")

summary(model.6)
```
```{r}
# Predicted values
predicted_values <- predict(model.6, type = "response")

# Observed values
observed_values <- df_sex$DiversityScore

# Scatter plot
plot(observed_values, predicted_values,
     xlab = "Observed Values",
     ylab = "Predicted Values",
     main = "Predicted vs Observed",
     pch = 16, col = "blue")
abline(a = 0, b = 1, col = "red", lwd = 2)

df_sex$predicted_values <- predicted_values
ggplot(df_sex, aes(x = Age, y = DiversityScore, color = Name)) +
  geom_point() +
  geom_line(aes(y = predicted_values), linetype = "dashed") +
  labs(title = "Fitted Model by Group", x = "Age", y = "Diversity Score") +
  theme_minimal() +
  theme(legend.position = "none")
```

Based on the model output, the RMSE of the model is 0.43.




