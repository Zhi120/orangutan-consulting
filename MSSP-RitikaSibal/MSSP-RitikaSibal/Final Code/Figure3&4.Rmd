---
title: "Figure3&4"
author: "Ritika"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, comment = "##", prompt = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 75), fig.path = "Figure3&4 Images/")
```

## Load all the necessary libraries

``` {r librarys, echo = T, results = 'hide', message=FALSE, warnings=FALSE}
library(tidyverse)
library(magrittr) # needs to be run every time you start R and want to use %>%
library(dplyr)  
library(vegan)
library(readxl)
library(effects)
library(ggeffects)
library(gridExtra)
library(ggstance)
library(MuMIn)
library(DHARMa)
library(sjPlot)
library(glmmTMB)
library(lme4)
library(ggpubr)
library(gridExtra)
library(entropy)
library(ggtext)
library(MuMIn)
```

## Postprocess Data

This is run everytime. Make sure to change this path to your local directory

``` {r postprocessing_data}
load_in_data_post <- function(path, adult){
  #path = "~/Desktop/W24/Research/OntogenyOfLocomotion/Ritika Excel Files/parsed-all.xlsx"
  d <- read_xlsx(path ,sheet = 1, guess_max = 1048576)
  
  d_cols <- read_xlsx(path,sheet = 2, guess_max = 1048576)
  d<- subset(d, `Minutes awake` >= 360)
  # Make NAs to Zeros
  d <- imputeTS::na_replace(d)
  # Make everything numeric
  d[8:ncol(d)] <- sapply(d[8:ncol(d)],as.numeric)
  
  if (adult){
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age", "Mother Class")]
      df$Age <- tolower(df$Age)
  } else {
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age","Age class lookup", "Age Class II lookup")]
      df$`Age class lookup` <- tolower(df$`Age class lookup`)
       df$`Age Class II lookup` <- tolower(df$`Age Class II lookup`)
  }

  names(d) <- sub("PB ", "", names(d))
  names(d) <- sub(" TotalMinute", "", names(d))
  names(d) <- sub(" TotalMinutes", "", names(d))

  # Drop all the NAs
  df<-df[!is.na(df$`Follow Number`), ]
  df<-df[!is.na(df$Name), ]
  df<-df[!is.na(df$`Minutes awake`), ]
  
  # Do all the non-pooled
  for (col_name in d_cols$Nonpooled) {
    index <- grepl(col_name, colnames(d))
    df <- cbind(df, d[index])
  }
  
  # Do all the pooled categories
  for (idx in 1:length(na.omit(d_cols$Pooled))) {
    cat <- strsplit(d_cols$Categories[idx], "")
    for (jdx in 1:length(cat[[1]])) {
      string = paste(d_cols$Pooled[idx], cat[[1]][jdx], sep = "")
      index <- grepl(string, colnames(d))
      if (jdx == 1){
        pooled_min <- d[index]
      } else {
        pooled_min <- pooled_min + d[index]
      }
    }
    colnames(pooled_min)[1] <- paste(d_cols$Pooled[idx], d_cols$Categories[idx], sep="")
    # divide so that the proportion of the day still makes sense
    #df <- cbind(df, pooled_min/length(cat[[1]]))
    df <- cbind(df, pooled_min)
  }
  
  # Normalize Data
  if(adult){
      df[,6:ncol(df)] <- df[,6:ncol(df)]/df$`Minutes awake`
      df <-df[rowSums(df[, 6:ncol(df)] > 1) == 0, ]
  } else{
      df[,7:ncol(df)] <- df[,7:ncol(df)]/df$`Minutes awake`
      df <-df[rowSums(df[, 7:ncol(df)] > 1) == 0, ]
  }
  
  if (adult) {
    df <- df %>% mutate(Age = case_when(
      # mothers with old children
      grepl('\\badult female\\b', Age) & (grepl('\\bOver\\b', `Mother Class`) |  grepl('\\<JUV\\>', `Mother Class`)) ~ 7)) # Over 4 years
    colnames(df)[5] <- "Age class lookup"
  } else{
    #df$Age = as.numeric(df$Age)
    df <- df %>% mutate(Age = case_when(
      Age >= 0  & Age < 2 ~ '1',
      Age >= 2  & Age < 4 ~ '2',
      Age >= 4  & Age < 6 ~ '3',
      Age >= 6  & Age < 8 ~ '4',
      Age >= 8  & Age < 10 ~ '5',
      Age >= 10  & Age < 12 ~ '6',
      # non mothers
      Age >= 12 & grepl('\\badult female\\b', `Age class lookup`) & grepl('\\bnon-mother\\b', `Age Class II lookup`) ~ '7',
      Age >= 12 & grepl ('\\bflanged male\\b', `Age class lookup`) ~ '7'))
    df <- df %>% select(-contains('Age Class II lookup'))
  }

  df<-df[!is.na(df$Age), ]
  df <- df %>% replace(is.na(.), 0)
  
  return(df)
}

d_juv <- load_in_data_post("../parsed-all.xlsx", adult=FALSE)

d_adult <- load_in_data_post("../parsed-mother-infant.xlsx", adult=TRUE)

d <- rbind(d_juv, d_adult)
d <- d %>% distinct(`Follow Number`, .keep_all = TRUE)

rm(d_juv, d_adult)

#library("writexl")
#write_xlsx(d,"~/Desktop/W24/Research/OntogenyOfLocomotion/all-juve-adult_female_.xlsx")
```

## Seperate data into sex

``` {r map_to_sex}
sex_d <- d %>% mutate(`Age class lookup` = case_when(
    grepl('\\bfemale\\b', `Age class lookup`) ~ 'F',
    grepl('\\bmale\\b', `Age class lookup`) ~ 'M'
    ))
d_dict <- sex_d[, c("Name", "Age class lookup")]
d_dict <- unique(d_dict)
d_dict<-d_dict[!is.na(d_dict$`Age class lookup`), ]
names(d_dict)[names(d_dict) == "Age class lookup"] <- "Sex"

dict <- read_xlsx("../IndividualSex.xlsx" ,sheet = 1, guess_max = 1048576)
dict <- dict %>% select(-contains('Entry Date'))

sex_dict <- rbind(dict, d_dict)
sex_dict$Name <- tolower(sex_dict$Name)
```

``` {r diversity_calculations}
calculateDiversisty <- function(d){
  metric_d <- d
  metric_d$Name <- tolower(metric_d$Name)
  
  act_colnames <- unique(colnames(metric_d[,6:ncol(metric_d)])) #Ignore the first 6 cols, just look at PB
  
  dive_d_list <- list()
   
  for (j in unique(metric_d$Name)){
    name <- metric_d[grepl(j, metric_d$Name, ignore.case = TRUE),]
    #name[is.na(name)] <- 0
    # find the name
    sex <- (subset(sex_dict, `Name` == j))$Sex
    for (y in unique(name$`Follow Number`)){
        follow <- subset(name, `Follow Number` == y)
        for (i in min(follow$Age):max(follow$Age)){
          age <- subset(follow, Age == i)
          div <- diversity(colSums(age[,6:ncol(age)]))
          if (div > 0 & !identical(sex, character(0))){
            dive_d_list[[length(dive_d_list) + 1]] <- data.frame(
              FollowNumber = y, 
              Name = j, 
              Age = i, 
              Sex = sex, 
              DiversityScore = as.numeric(div), 
              stringsAsFactors = FALSE  
            )
          }
        }
      }
    }
  dive_d <- do.call(rbind, dive_d_list)
  dive_d <- dive_d %>% distinct(`FollowNumber`, .keep_all = TRUE)
  return(dive_d)
}

dive_d <- calculateDiversisty(d)
dive_d$DiversityScore <- as.numeric(dive_d$DiversityScore)
dive_d$Age <- as.numeric(dive_d$Age)

# Remove adults since we didnt have data for males at ages 10-12
dive_d_f <- subset(dive_d, `Sex` == "F" & Age != 7)
dive_d_m <- subset(dive_d, `Sex` == "M" & Age != 7)
# Remove the Sex column
dive_d_f <- subset( dive_d_f, select = -Sex )
dive_d_m <- subset( dive_d_m, select = -Sex )
```
```{r}
# write.csv(dive_d, "diversity_score_withsex.csv")
```

## T-Tests between the sexes

``` {r t_tests}
# Create a list of all the t-test scores
t_score <- c()
t_score[1] <- t.test(x=dive_d_f$DiversityScore[dive_d_f$Age==1], y=dive_d_m$DiversityScore[dive_d_m$Age==1])[["p.value"]]
t_score[2] <- t.test(x=dive_d_f$DiversityScore[dive_d_f$Age==2], y=dive_d_m$DiversityScore[dive_d_m$Age==2])[["p.value"]]
t_score[3] <- t.test(x=dive_d_f$DiversityScore[dive_d_f$Age==3], y=dive_d_m$DiversityScore[dive_d_m$Age==3])[["p.value"]]
t_score[4] <- t.test(x=dive_d_f$DiversityScore[dive_d_f$Age==4], y=dive_d_m$DiversityScore[dive_d_m$Age==4])[["p.value"]]
t_score[5] <- t.test(x=dive_d_f$DiversityScore[dive_d_f$Age==5], y=dive_d_m$DiversityScore[dive_d_m$Age==5])[["p.value"]]

# Calculate sample sizes
sample_sizes_f <- dive_d_f %>% 
  group_by(Age) %>%
  summarise(n = n())

sample_sizes_m <- dive_d_m %>% 
  group_by(Age) %>%
  summarise(n = n())

# Needed for plotting
dive_d_f$sex <- "Female"
dive_d_m$sex <- "Male"
combined_df <- rbind(dive_d_f, dive_d_m)
bin_labels <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")
combined_df$Age = as.factor(combined_df$Age)

# Plot the results!
ggplot() +
  geom_point(data=combined_df, aes(x=Age, y=DiversityScore, fill=sex, color=sex), size = 0.75, shape = 1, position = position_jitterdodge()) +
  geom_boxplot(data=combined_df, aes(x=Age, y=DiversityScore, color=sex), alpha = 0.6) +
  theme_classic() + 
  scale_color_manual(values = c("#a1b0f7","#8ac3a3")) +
  scale_x_discrete(breaks=c(1, 2, 3, 4, 5, 6, 7), labels=bin_labels) + 
  ylab("Positional Behavior Diversity Score") +
  ggtitle("Paired t-test between sex diversity scores") +
  # Look at the values to annotate this accordingly
  annotate("text", x = 1, y = 2.75, label = "***", size = 4) +
  annotate("text", x = 2, y = 2.75, label = "***", size = 4) +
  annotate("text", x = 3, y = 2.75, label = "**", size = 4) +
  annotate("text", x = 4, y = 2.75, label = "***", size = 4) +
  annotate("text", x = 5, y = 2.75, label = "***", size = 4) + 
  geom_text(data = sample_sizes_f, aes(x = Age, y = 3, label = paste("n =", n)), vjust = -0.5, color = "#a1b0f7", size=3) + 
  geom_text(data = sample_sizes_m, aes(x = Age, y = 3.2, label = paste("n =", n)), vjust = -0.5, color = "#8ac3a3", size=3) + 
  theme(legend.title=element_blank())
```

## GLMM Analysis

Gaussian with log link chosen

``` {r glmm analysis}

best_model <- function(dive_d){
  models<-list()
  model.1 <- glmmTMB(data=dive_d, DiversityScore ~  (1|Name) + (1|FollowNumber), family=gaussian(link="log"))
  models[[1]] <- model.1

  model.2 <- glmmTMB(data=dive_d, DiversityScore ~ Age + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
  models[[2]] <- model.2

  model.3 <- glmmTMB(data=dive_d, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
  models[[3]] <- model.3
  
  aics=c(summary(model.1)$AIC[1], summary(model.2)$AIC[1], summary(model.3)$AIC[1])
  # Test that adding age actually made the model better
  print(anova(model.1,model.2))
  print(anova(model.2,model.3))
  return(models[[which.min(aics)]])

}

dive_d_f$DiversityScore <- as.numeric(dive_d_f$DiversityScore)
dive_d_f$Age <- as.numeric(dive_d_f$Age)
model_F <- best_model(dive_d_f)
summary(model_F)

dive_d_m$DiversityScore <- as.numeric(dive_d_m$DiversityScore)
dive_d_m$Age <- as.numeric(dive_d_m$Age)
model_M <- best_model(dive_d_m)
summary(model_M)
```
? underdispersion problem

## Plot the GLMM

Here we plot the GLMM predictions with the original data

``` {r glmm_plot}
predict_f <- ggpredict(model_F, terms="Age [all]") 
predict_m <- ggpredict(model_M, terms="Age [all]") 

bin_labels <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")

ggplot() + theme_classic() + 
  geom_count(data=dive_d_f, aes(x=Age, y=DiversityScore, color="Female"), alpha=0.1, size=0.75) +
  geom_count(data=dive_d_m, aes(x=Age, y=DiversityScore, color="Male"), alpha=0.1, size=0.75) +
geom_line(data = predict_f, aes(x, predicted, color = "Female"), size=1) +
geom_line(data = predict_m, aes(x, predicted, color = "Male"), size=1) +
  geom_ribbon(data=predict_f, aes(x=x, y=predicted, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.15, fill="#eeaf61") +
  geom_ribbon(data=predict_m, aes(x=x, y=predicted, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.15, fill="#355886") +
scale_color_manual(values = c(Female = "#eeaf61", Male = "#355886"), labels = c(Female = "Female", Male = "Male"), name="Sex") +
  ylab("Positional Behavior Diversity Score")  +
  xlab("Age (years)") +
  ggtitle("Sex Based Ontogeny of Positional Behavior") + 
theme(axis.text=element_text(size=7), axis.text.x = element_text(size=7), axis.title.y = element_text(size=8), title = element_text(size=9)) + scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7), labels=bin_labels) + 
  theme(legend.title=element_blank()) + coord_fixed(ratio = 2)
```

## Analyse the GLMM

```{r analyse_glmm_model_adult, eval=FALSE}
plot_model(model_F, show.values = TRUE, type = "est", title = "Females", vline.color = "black")

sim_res <- simulateResiduals(model_F, 250, quantreg=T)
testDispersion(model_F)
testDispersion(model_F, type="PearsonChisq", alternative="greater")
testUniformity(model_F) 
plotResiduals(sim_res)

r.squaredGLMM(model_F)
confint(model_F) # make sure the confints dont cross 0

plot_model(model_M, show.values = TRUE, type = "est", title = "Males", vline.color = "black")
sim_res <- simulateResiduals(model_M, 250, quantreg=T)
testDispersion(model_M)
testDispersion(model_M, type="PearsonChisq", alternative="greater")
testUniformity(model_M) 
plotResiduals(sim_res)

confint(model_M) # make sure the confints dont cross 0
r.squaredGLMM(model_M)
```


## Plot the stacked barplots

Everything has been scaled to equal 1 (for the day)

``` {r stacked barplot}
stacked_graph <- function(metric_d, name){
  graph_d <- data.frame(Age=integer(), Action=character(), Proportion=integer())
  
  for (i in 1:nrow(metric_d)){
      for(j in colnames(metric_d[6:ncol(metric_d)])){
        if(metric_d[j][i,1] != 0){
          graph_d[nrow(graph_d) + 1,] <- c(metric_d$Age[i], j, metric_d[j][i,1])
        }
      }
  }
  
  ## Plotting Stacked Bargraph
  graph_d$Proportion = as.numeric(graph_d$Proportion)
  graph_d$Age = as.numeric(graph_d$Age)
  
  graph_d <- aggregate(Proportion ~ Age + Action , FUN = mean, data=graph_d)
  
  for(x in 1:length(graph_d$Action)){
    graph_d$Action[x] <- paste(unlist(strsplit(graph_d$Action[x], "(?<=[a-z])(?=[A-Z])", perl = TRUE)[[1]][1:2]), collapse="")
  }
  
  graph_d <- aggregate(Proportion ~ Age + Action , FUN = sum, data=graph_d)
  
  
  graph_d <- graph_d[,order(colnames(graph_d))]
  
  # label as seperate png stuff
  #bin_labels <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults", "Flanged Male", "Unflanged Male")
  # plot_leg <- ggplot(graph_d, aes(fill = Action, y = Proportion, x = Age)) + geom_bar(stat = "identity", position = "stack")+ scale_fill_manual(values = c("#8e7cc3",
  # "#72d3fe","#84d9ff","#98ddfc","#a9e5ff","#bbeaff",
  # "#80bf4d","#8eb15c","#a0c172", "#b1cf86", "#c1db9b", "#d2e6b5", "#d1eca8",
  # "#ffd58b", "#ffe37a", "#ffea61", "#fff192", "#fbffa1",
  # "#e36aa5", "#ea8b9f", "#f39fb1", "#fbafc0", "#f5c4d1", "#f5d3d8")) + guides(fill = guide_legend(ncol = 1))
  
  # legend <- get_legend(plot_leg)                     
  # grid.newpage()                               
  # grid.draw(legend)  
  # ggsave(file="legend.png",legend, width=22,height=21,units=c("cm"), dpi=600)
  # 
  ggplot(graph_d, aes(fill = Action, y = Proportion, x = Age)) +
  geom_bar(stat = "identity", position = "fill", lwd=0.01, width=.9, show.legend=FALSE) +  ylim(0,1) + ggtitle(name) +   theme_classic() +   ylab("Daily Activity Distribution") +
    xlab("Age (years)") + #scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7, 8, 9), labels=bin_labels) +
    scale_fill_manual(values = c("#8e7cc3",
  "#72d3fe","#84d9ff","#98ddfc","#a9e5ff","#bbeaff",
  "#80bf4d","#8eb15c","#a0c172", "#b1cf86", "#c1db9b", "#d2e6b5", "#d1eca8",
  "#ffd58b", "#ffe37a", "#ffea61", "#fff192", "#fbffa1",
  "#e36aa5", "#ea8b9f", "#f39fb1", "#fbafc0", "#f5c4d1", "#f5d3d8")) +
    scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7), labels=bin_labels)
}

d['Sex'] = NA

for(row in 1:nrow(d)){
  j = tolower(d$Name[row])
  d$Sex[row] = (subset(sex_dict, Name == j))$Sex[1]
}

d <- d %>% replace(is.na(.), 0)
stacked_graph(d[d$Sex == "F",1:ncol(d)-1], name="Females")
stacked_graph(d[d$Sex == "M",1:ncol(d)-1], name ="Male")
```

## Supplemental Figure

Compare the underlying distributions using gstatistic

``` {r supplemental_gstat}
female_d <- d[d$Sex == "F",1:ncol(d)-1]
female_d <- aggregate(female_d[7:ncol(female_d)-1], by=female_d[4],  FUN = mean)
female_d <- mutate_all(female_d, function(x) as.numeric(as.character(x)))
female_d <- female_d %>% select_if(colSums(.) != 0)

male_d <- d[d$Sex == "M",1:ncol(d)-1]
male_d <- aggregate(male_d[7:ncol(male_d)-1], by=male_d[4],  FUN = mean)
male_d <- mutate_all(male_d, function(x) as.numeric(as.character(x)))
male_d <- male_d %>% select_if(colSums(.) != 0)

fem_age_1 <- subset(female_d, Age == 1)
fem_age_1 <- fem_age_1[,2:ncol(fem_age_1)]
fem_age_1 <- as.numeric(fem_age_1/rowSums(fem_age_1))
male_age_1 <- subset(male_d, Age == 1)
male_age_1 <- male_age_1[,2:ncol(male_age_1)]
male_age_1 <- as.numeric(male_age_1/rowSums(male_age_1))

fem_age_2 <- subset(female_d, Age == 2)
fem_age_2 <- fem_age_2[,2:ncol(fem_age_2)]
fem_age_2 <- as.numeric(fem_age_2/rowSums(fem_age_2))

male_age_2 <- subset(male_d, Age == 2)
male_age_2 <- male_age_2[,2:ncol(male_age_2)]
male_age_2 <- as.numeric(male_age_2/rowSums(male_age_2))


fem_age_3 <- subset(female_d, Age == 3)
fem_age_3 <- fem_age_3[,2:ncol(fem_age_3)]
fem_age_3 <- as.numeric(fem_age_3/rowSums(fem_age_3))

male_age_3 <- subset(male_d, Age == 3)
male_age_3 <- male_age_3[,2:ncol(male_age_3)]
male_age_3 <- as.numeric(male_age_3/rowSums(male_age_3))


fem_age_4 <- subset(female_d, Age == 4)
fem_age_4 <- fem_age_4[,2:ncol(fem_age_4)]
fem_age_4 <- as.numeric(fem_age_4/rowSums(fem_age_4))

male_age_4 <- subset(male_d, Age == 4)
male_age_4 <- male_age_4[,2:ncol(male_age_4)]
male_age_4 <- as.numeric(male_age_4/rowSums(male_age_4))


fem_age_5 <- subset(female_d, Age == 5)
fem_age_5 <- fem_age_5[,2:ncol(fem_age_5)]
fem_age_5 <- as.numeric(fem_age_5/rowSums(fem_age_5))

male_age_5 <- subset(male_d, Age == 5)
male_age_5 <- male_age_5[,2:ncol(male_age_5)]
male_age_5 <- as.numeric(male_age_5/rowSums(male_age_5))


fem_age_7 <- subset(female_d, Age == 7)
fem_age_7 <- fem_age_7[,2:ncol(fem_age_7)]
fem_age_7 <- as.numeric(fem_age_7/rowSums(fem_age_7))

male_age_7 <- subset(male_d, Age == 7)
male_age_7 <- male_age_7[,2:ncol(male_age_7)]
male_age_7 <- as.numeric(male_age_7/rowSums(male_age_7))


age_1_g <- Gstat(fem_age_1, male_age_1)
summary_df <- data.frame(Class=c('Age 0-2'), Gstat=age_1_g[1], pval=age_1_g[3])
age_2_g <- Gstat(fem_age_2, male_age_2)
summary_df[nrow(summary_df) + 1,] = c('Age 2-4', age_2_g[1], age_2_g[3])
age_3_g <- Gstat(fem_age_3, male_age_3)
summary_df[nrow(summary_df) + 1,] = c('Age 4-6', age_3_g[1], age_3_g[3])
age_4_g <- Gstat(fem_age_4, male_age_4)
summary_df[nrow(summary_df) + 1,] = c('Age 6-8', age_4_g[1], age_4_g[3])
age_5_g <- Gstat(fem_age_5, male_age_5)
summary_df[nrow(summary_df) + 1,] = c('Age 8-10', age_5_g[1], age_5_g[3])

plot.new()
grid.table(summary_df)
```
```