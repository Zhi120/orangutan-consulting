---
title: "Figure2"
author: "Ritika"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
# Change path to your local directory
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, comment = "##", prompt = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 75), fig.path = "/Users/ritikasibal/Desktop/W24/Research/OntogenyOfLocomotion/Final Code/Figure2 Images/")
```
## Load all the necessary libraries

``` {r librarys, echo = T, results = 'hide', message=FALSE, warnings=FALSE}
library(tidyverse)
library(magrittr) # needs to be run every time you start R and want to use %>%
library(dplyr)  
library(vegan)
library(readxl)
library(effects)
library(ggeffects)
library(gridExtra)
library(ggstance)
library(MuMIn)
library(DHARMa)
library(sjPlot)
library(glmmTMB)
library(lme4)
library(openxlsx)
library(reshape2)
```

## Postprocess Data

This is run everytime. Make sure to change this path to your local directory

``` {r postprocessing_data}
load_in_data_post <- function(path, adult){
  #adult=FALSE
  #path = "~/Desktop/W24/Research/OntogenyOfLocomotion/Ritika Excel Files/parsed-all.xlsx"
  d <- read_xlsx(path ,sheet = 1, guess_max = 1048576)
  
  d_cols <- read_xlsx(path,sheet = 2, guess_max = 1048576)
  d<- subset(d, `Minutes awake` >= 360)
  # Make NAs to Zeros
  d <- imputeTS::na_replace(d)
  # Make everything numeric
  d[8:ncol(d)] <- sapply(d[8:ncol(d)],as.numeric)

  
  if (adult){
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age", "Mother Class")]
      df$Age <- tolower(df$Age)
  } else {
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age","Age class lookup", "Age Class II lookup")]
      df$`Age class lookup` <- tolower(df$`Age class lookup`)
       df$`Age Class II lookup` <- tolower(df$`Age Class II lookup`)
  }

  names(d) <- sub("PB ", "", names(d))
  names(d) <- sub(" TotalMinute", "", names(d))
  names(d) <- sub(" TotalMinutes", "", names(d))
  # Drop all the NAs
  df<-df[!is.na(df$`Follow Number`), ]
  df<-df[!is.na(df$Name), ]
  df<-df[!is.na(df$`Minutes awake`), ]
  
  # Do all the non-pooled
  for (col_name in d_cols$Nonpooled) {
    index <- grepl(col_name, colnames(d))
    df <- cbind(df, d[index])
  }
  
  # Do all the pooled categories
  for (idx in 1:length(na.omit(d_cols$Pooled))) {
    cat <- strsplit(d_cols$Categories[idx], "")
    for (jdx in 1:length(cat[[1]])) {
      string = paste(d_cols$Pooled[idx], cat[[1]][jdx], sep = "")
      index <- grepl(string, colnames(d))
      if (jdx == 1){
        pooled_min <- d[index]
      } else {
        pooled_min <- pooled_min + d[index]
      }
    }
    colnames(pooled_min)[1] <- paste(d_cols$Pooled[idx], d_cols$Categories[idx], sep="")
    # divide so that the proportion of the day still makes sense
    #df <- cbind(df, pooled_min/length(cat[[1]]))
    df <- cbind(df, pooled_min)
  }
  
  # Normalize Data
  if(adult){
      df[,6:ncol(df)] <- df[,6:ncol(df)]/df$`Minutes awake`
      df <-df[rowSums(df[, 6:ncol(df)] > 1) == 0, ]
  } else{
      df[,7:ncol(df)] <- df[,7:ncol(df)]/df$`Minutes awake`
      df <-df[rowSums(df[, 7:ncol(df)] > 1) == 0, ]
  }

  # For age model
  #df$Age = as.numeric(df$Age)
  #df$Age[df$Age > 12] = 12
  #df <- df %>% mutate(Age = case_when(Age > 12 ~ '12'))
  if (adult) {
    df <- df %>% mutate(Age = case_when(
      # mothers with old children
      grepl('\\badult female\\b', Age) & (grepl('\\bOver\\b', `Mother Class`) |  grepl('\\<JUV\\>', `Mother Class`)) ~ 7)) # Over 4 years
    colnames(df)[5] <- "Age class lookup"
  } else{
    #df$Age = as.numeric(df$Age)
    df <- df %>% mutate(Age = case_when(
      Age >= 0  & Age < 2 ~ '1',
      Age >= 2  & Age < 4 ~ '2',
      Age >= 4  & Age < 6 ~ '3',
      Age >= 6  & Age < 8 ~ '4',
      Age >= 8  & Age < 10 ~ '5',
      Age >= 10  & Age < 12 ~ '6',
      # non mothers
      Age >= 12 & grepl('\\badult female\\b', `Age class lookup`) & grepl('\\bnon-mother\\b', `Age Class II lookup`) ~ '7',
      Age >= 12 & grepl ('\\bflanged male\\b', `Age class lookup`) ~ '7'))
    df <- df %>% select(-contains('Age Class II lookup'))
  }
  
  df<-df[!is.na(df$Age), ]
  df <- df %>% replace(is.na(.), 0)
  
  return(df)
}

d_juv <- load_in_data_post("~/Desktop/W24/Research/OntogenyOfLocomotion/Ritika Excel Files/parsed-all.xlsx", adult=FALSE)

d_adult <- load_in_data_post("~/Desktop/W24/Research/OntogenyOfLocomotion/Ritika Excel Files/parsed-mother-infant.xlsx", adult=TRUE)

d <- rbind(d_juv, d_adult)
d <- d %>% distinct(`Follow Number`, .keep_all = TRUE)

rm(d_juv, d_adult)

#library("writexl")
#write_xlsx(d,"~/Desktop/W24/Research/OntogenyOfLocomotion/all-juve-adult_female_.xlsx")
```

## Matrix of P-Tests

Run P-Tests between every age group for each category. We did paired t-tests with Bonferroni corrections giving us an alpha level of 0.002 (7 groups, 21 possible comparisons)

``` {r matrix_of_p_tests}
graph_d <- data.frame(Age=integer(), Action=character(), Proportion=integer())

for (i in 1:nrow(d)){
    for(j in colnames(d[6:ncol(d)])){
      if(d[j][i,1] != 0){
        graph_d[nrow(graph_d) + 1,] <- c(d$Age[i], j, d[j][i,1])
      }
    }
}

graph_d$Proportion = as.numeric(graph_d$Proportion)
graph_d$Age = as.numeric(graph_d$Age)
all_d <- graph_d

# This function actually loops through all the age groups in each caterogry and performs p-tests 
# between each pairs of age groups (e.g. Age1 vs Age2, Age1 vs Age3)
heatmap_t <- function(d, Act){
  list_of_matrices <- list()
  mask <-  grepl(Act, d$Action)
  action_d <- d[mask, ]
  # Loop over pairs and perform t-tests
  for(j in unique(action_d$Action)){
    subset_action_d <- subset(action_d, Action == j)
    group_pairs <- combn(unique(action_d$Age), 2)
    p_matrix <- matrix(nrow = length(unique(action_d$Age)), 
                   ncol = length(unique(action_d$Age)),
                   dimnames = list(unique(action_d$Age),
                                   unique(action_d$Age)))
    for(i in 1:ncol(group_pairs)) {
      group1 <- group_pairs[1, i]
      group2 <- group_pairs[2, i]
      
      t_test_result <- try(t.test(x=subset_action_d$Proportion[subset_action_d$Age==group1], y=subset_action_d$Proportion[subset_action_d$Age==group2]), silent=TRUE)

      if (class(t_test_result) == "try-error") {
        p_matrix[group1, group2] <- FALSE
        p_matrix[group2, group1] <- FALSE
      } else {
        # Bonferoni correction
        if(t_test_result$p.value <= 0.002){
          p_matrix[group1, group2] = TRUE
          p_matrix[group2, group1] = TRUE
        } else{
          p_matrix[group1, group2] = FALSE
          p_matrix[group2, group1] = FALSE
        }
      }
    }
    diag(p_matrix) <- FALSE
    list_of_matrices[[j]] <- p_matrix
  }
  return(list_of_matrices)
}

travel_matrices <- heatmap_t(all_d, 'Travel')
cling_matrices <- heatmap_t(all_d, 'Cling')
eat_matrices <- heatmap_t(all_d, 'Eat')
play_matrices <- heatmap_t(all_d, 'Play')
rest_matrices <- heatmap_t(all_d, 'Rest')
```

## Plot the results in a single heatmap.

Only show values with significance under 0.002

``` {r heatmap}
d <- d

graph_d <- data.frame(Age=integer(), Action=character(), Proportion=integer())

for (i in 1:nrow(d)){
    for(j in colnames(d[6:ncol(d)])){
      if(d[j][i,1] != 0){
        graph_d[nrow(graph_d) + 1,] <- c(d$Age[i], j, d[j][i,1])
      }
    }
}

graph_d$Proportion = as.numeric(graph_d$Proportion)
graph_d$Age = as.numeric(graph_d$Age)

graph_d <- aggregate(Proportion ~ Age + Action , FUN = mean, data=graph_d)
all_d <- graph_d

plot_heatmap <- function(juv_values, name, significance_list){
  # Extract levels and create indices for actions
  y_levels <- levels(factor(juv_values$Action))
  y_indices <- seq_along(y_levels)
  names(y_indices) <- y_levels
  juv_values$Age <- as.factor(juv_values$Age)
  
  # Set up the heatmap plot
  p <- ggplot(juv_values, aes(x = Age, y = Action, fill = value)) +
      geom_tile() +
      scale_fill_gradient2(low = "white", high = "grey", limit = c(0, 0.7)) +
      guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10, title = "Proportion of Day")) + 
      scale_x_discrete(breaks=c(1, 2, 3, 4, 5, 6, 7), labels=c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")) + 
      theme_classic() +
      ylab("Positional Behavior Category") +
      xlab("Age (years)")

  # Loop through each action and plot all significant connections
  for (action in unique(juv_values$Action)) {
    if (action %in% names(significance_list)) {
      sig_matrix <- significance_list[[action]]
      action_pos <- y_indices[action]
      num_connections <- sum(sig_matrix)
      spacing <- 1.9 / max(1, num_connections)
      i = 1
      current_offset <- 0  # Initialize offset for this action
      for (start_age in seq_len(nrow(sig_matrix))) {
        for (end_age in seq_len(ncol(sig_matrix))) {
          if (sig_matrix[start_age, end_age] & (start_age < end_age)) {
            p <- p + annotate("segment", x = start_age, xend = end_age, 
                              y = action_pos + 0.4 -current_offset, yend = action_pos + 0.4 -current_offset, 
                              color = "black", size = 0.2) +
                  annotate("point", x = start_age, y = action_pos + 0.4 - current_offset, color = "black", size = 1) +
                  annotate("point", x = end_age, y = action_pos + 0.4 - current_offset, color = "black", size = 1)
            current_offset <- current_offset + spacing
            i = i+1
          }
        }
      }
    }
  }

  # Print the final plot
  print(p)
}

generate_heatmap <- function(graph_d1){
  df_melted <- melt(graph_d1, id.vars = c("Age", "Action"))
  all_matrices <- c(travel_matrices, eat_matrices, rest_matrices, cling_matrices, play_matrices)
  plot_heatmap(df_melted, "All", all_matrices)
}

generate_heatmap(subset(all_d, Proportion >= 0.1))
```