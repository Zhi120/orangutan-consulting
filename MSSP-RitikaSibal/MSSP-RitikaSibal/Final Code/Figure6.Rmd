---
title: "Figure6"
author: "Ritika"
date: "`r Sys.Date()`"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, comment = "##", prompt = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 75), fig.path = "/Users/ritikasibal/Desktop/W24/Research/OntogenyOfLocomotion/Final Code/Figure6 Images/")
```

## Load all the necessary libraries

``` {r librarys, echo = T, results = 'hide', message=FALSE, warnings=FALSE}
library(tidyverse)
library(magrittr) # needs to be run every time you start R and want to use %>%
library(dplyr)  
library(vegan)
library(readxl)
library(effects)
library(ggeffects)
library(gridExtra)
library(ggstance)
library(MuMIn)
library(DHARMa)
library(sjPlot)
library(glmmTMB)
library(lme4)
library( ggpubr )
library("grid") 
library("gridExtra") 
library("cowplot") 
```

## Postprocess Data

This is run everytime. Make sure to change this path to your local directory

``` {r postprocessing_data}
load_in_data_post <- function(path, adult){
  d <- read_xlsx(path ,sheet = 1, guess_max = 1048576)
  
  d_cols <- read_xlsx(path,sheet = 2, guess_max = 1048576)
  d<- subset(d, `Minutes awake` >= 360)
  # Make NAs to Zeros
  d <- imputeTS::na_replace(d)
  # Make everything numeric
  d[8:ncol(d)] <- sapply(d[8:ncol(d)],as.numeric)
  # Normalize Data
  d <- d%>%mutate(across(starts_with("PB"), ~ .x / `Minutes awake`))
  
  if (adult){
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age", "Mother Class")]
      df$Age <- tolower(df$Age)
  } else {
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age","Age class lookup", "Age Class II lookup")]
      df$`Age class lookup` <- tolower(df$`Age class lookup`)
       df$`Age Class II lookup` <- tolower(df$`Age Class II lookup`)
  }

  names(d) <- sub("PB ", "", names(d))
  names(d) <- sub(" TotalMinute", "", names(d))
  names(d) <- sub(" TotalMinutes", "", names(d))

  # Drop all the NAs
  df<-df[!is.na(df$`Follow Number`), ]
  df<-df[!is.na(df$Name), ]
  df<-df[!is.na(df$`Minutes awake`), ]
  
  # Do all the non-pooled
  for (col_name in d_cols$Nonpooled) {
    index <- grepl(col_name, colnames(d))
    df <- cbind(df, d[index])
  }
  
  # Do all the pooled categories
  for (idx in 1:length(na.omit(d_cols$Pooled))) {
    cat <- strsplit(d_cols$Categories[idx], "")
    for (jdx in 1:length(cat[[1]])) {
      string = paste(d_cols$Pooled[idx], cat[[1]][jdx], sep = "")
      index <- grepl(string, colnames(d))
      if (jdx == 1){
        pooled_min <- d[index]
      } else {
        pooled_min <- pooled_min + d[index]
      }
    }
    colnames(pooled_min)[1] <- paste(d_cols$Pooled[idx], d_cols$Categories[idx], sep="")
    df <- cbind(df, pooled_min)
  }
  

  df$Name = tolower(df$Name)
  df_wuh <- subset(df, Name == "walimah")
  
  df_berani <- subset(df, Name == "berani")

  d <- rbind(df_wuh, df_berani)
  df <- d
  
  if (adult) {
  } else{
    df$Age <- ceiling(df$Age)
  }
  df<-df[!is.na(df$Age), ]
  df <- df %>% replace(is.na(.), 0)
  
  return(df)
}

d <- load_in_data_post("~/Desktop/Knott-Lab-Research/OntogenyOfLocomotion/Ritika Excel Files/parsed-all.xlsx", adult=FALSE)
d <- d %>% select(-contains('Age Class II lookup'))
d <- d[d$Age < 60,] 
```

## Calculate Diversity

This is all done using the default shannon-weaver index, but you can change it to simpson or invsimpson

``` {r diversity_calculations}
calculateDiversisty <- function(d){
  metric_d <- d
  metric_d$Name <- tolower(metric_d$Name)

  act_colnames <- unique(colnames(metric_d[,6:ncol(metric_d)]))

  dive_d <- data.frame(FollowNumber=integer(),
                       Name=character(),
                       Age=integer(),
                      DiversityScore=integer())


  for (j in unique(metric_d$Name)){
    name <- metric_d[grepl(j, metric_d$Name, ignore.case = TRUE),]
    #name[is.na(name)] <- 0
    for (y in unique(name$`Follow Number`)){
        follow <- subset(name, `Follow Number` == y)
        for (i in min(follow$Age):max(follow$Age)){
          age <- subset(follow, Age == i)
          row_values <- c()
          for (x in act_colnames) {
            act_col <- sum(age[, c(x) ])
            row_values <- append(row_values, act_col)
          }
          div <- diversity(row_values)
          if (div > 0){
            dive_d[nrow(dive_d) + 1,] <- c(y, j, i, div)
            rm(row_values)
          }
        }
    }
  }
  return(dive_d)
}
dive_d <- calculateDiversisty(d)
dive_d$DiversityScore <- as.numeric(dive_d$DiversityScore)
dive_d$Age <- as.numeric(dive_d$Age)
```

## GLMM Analysis

Gaussian with log link chosen

``` {r glmm analysis}
best_model <- function(dive_d){
  models<-list()
  model.1 <- glmmTMB(data=dive_d, DiversityScore ~  (1|Name) + (1|FollowNumber), family=gaussian(link="log"))
  models[[1]] <- model.1

  model.2 <- glmmTMB(data=dive_d, DiversityScore ~ Age + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
  models[[2]] <- model.2

  model.3 <- glmmTMB(data=dive_d, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
  models[[3]] <- model.3
  
  aics=c(summary(model.1)$AIC[1], summary(model.2)$AIC[1], summary(model.3)$AIC[1])
  # Test that adding age actually made the model better
  print(anova(model.1,model.2))
  print(anova(model.2,model.3))
  return(models[[which.min(aics)]])

}
model_wuh <-  best_model(subset(dive_d, Name == "walimah"))
model_berani <-  best_model(subset(dive_d, Name == "berani"))
```

## Analyse the GLMM

```{r analyse_glmm_model_adult, eval=FALSE}
sim_res <- simulateResiduals(model_wuh, 250, quantreg=T)
testDispersion(model_wuh)
testDispersion(model_wuh, type="PearsonChisq", alternative="greater")
testUniformity(model_wuh)
plotResiduals(sim_res)


set_theme(base = theme_classic(), #To remove the background color and the grids
          theme.font = 'serif',   #To change the font type
          axis.title.size = 1.0,  #To change axis title size
          axis.textsize.x = 1.0,  #To change x axis text size
          axis.textsize.y = 1.0)  #To change y axis text size

plot_model(model_wuh, show.values = TRUE, type = "est", title = "Walimuh All", vline.color = "black")

sim_res <- simulateResiduals(model_wuh, 250, quantreg=T)
testDispersion(model_berani)
testDispersion(model_berani, type="PearsonChisq", alternative="greater")
testUniformity(model_berani)
plotResiduals(sim_res)


set_theme(base = theme_classic(), #To remove the background color and the grids
          theme.font = 'serif',   #To change the font type
          axis.title.size = 1.0,  #To change axis title size
          axis.textsize.x = 1.0,  #To change x axis text size
          axis.textsize.y = 1.0)  #To change y axis text size
plot_model(model_berani, show.values = TRUE, type = "est", title = "Berani All", vline.color = "black")

confint(model_berani) # make sure the confints dont cross 0
r.squaredGLMM(model_berani)

data_ber <- subset(dive_d, Name == "berani")
ggplot(data = data_ber) + 
  geom_jitter(aes(x = as.factor(Age), y = DiversityScore), color = "#66C2A5", size = 0.75, shape = 1) + 
  geom_boxplot(aes(x = as.factor(Age), y = DiversityScore), fill = "#E41A1C", color = "#377EB8", alpha = 0.6) +
  labs(title = "Distribution of Diversity Scores by Age for Berani",
       x = "Age",
       y = "Diversity Score") +
  theme_classic()
```

## Plot the GLMM

Here we plot the GLMM predictions with the original data

``` {r glmm_plot}
predict_wuh <- ggpredict(model_wuh, terms="Age [all]")
predict_berani <- ggpredict(model_berani, terms="Age [all]")

ggplot() + theme_classic() + 
  #geom_count(data=subset(dive_d, Name == "walimah"), aes(x=Age, y=DiversityScore, color="WalimahN"), alpha=0.1, size=0.75) +
  geom_count(data=subset(dive_d, Name == "berani"), aes(x=Age, y=DiversityScore, color="BeraniN"), alpha=0.1, size=0.75) +
  #geom_line(data = predict_wuh,aes(x, predicted, color = "WalimahN"), size=1) +
geom_line(data = predict_berani, aes(x, predicted, color = "BeraniN"), size=1) +
scale_color_manual(values = c(WalimahN = "#c6e2ff", BeraniN="#ffb6c1"), labels = c(WalimahN = "Walimah", BeraniN="Berani"), name="Orangutan Name") +
  geom_vline(xintercept = 7,  linetype = "dashed", color="#c6e2ff") + #Look at predict_berani to get the maximum index
  ylab("Positional Behavior Diversity Score")  +
  xlab("Age (years)") +
  ggtitle("Case Studies: Ontogeny of Positional Behavior") + 
theme(axis.text=element_text(size=7), axis.text.x = element_text(size=7), axis.title.y = element_text(size=8), title = element_text(size=9)) + ylim(0,2.5) #+ coord_fixed(ratio = 2)
```

## Plot the stacked barplots

Everything has been scaled to equal 1 (for the day)

``` {r stacked barplot}
stacked_graph <- function(metric_d, name){
  graph_d <- data.frame(Age=integer(), Action=character(), Proportion=integer())
  
  for (i in 1:nrow(metric_d)){
      for(j in colnames(metric_d[6:ncol(metric_d)])){
        if(metric_d[j][i,1] != 0){
          graph_d[nrow(graph_d) + 1,] <- c(metric_d$Age[i], j, metric_d[j][i,1])
        }
      }
  }
  
  ## Plotting Stacked Bargraph
  # Eventually do https://stackoverflow.com/questions/19568901/multiple-colour-scales-in-one-stacked-bar-plot-using-ggplot
  graph_d$Proportion = as.numeric(graph_d$Proportion)
  graph_d$Age = as.numeric(graph_d$Age)
  
  graph_d <- aggregate(Proportion ~ Age + Action , FUN = mean, data=graph_d)
  
  for(x in 1:length(graph_d$Action)){
    graph_d$Action[x] <- paste(unlist(strsplit(graph_d$Action[x], "(?<=[a-z])(?=[A-Z])", perl = TRUE)[[1]][1:2]), collapse="")
  }
  
  graph_d <- aggregate(Proportion ~ Age + Action , FUN = sum, data=graph_d)
  
  
  graph_d <- graph_d[,order(colnames(graph_d))]
  
  # label as seperate png stuff
  #bin_labels <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults", "Flanged Male", "Unflanged Male")
  # plot_leg <- ggplot(graph_d, aes(fill = Action, y = Proportion, x = Age)) + geom_bar(stat = "identity", position = "stack")+ scale_fill_manual(values = c("#8e7cc3",
  # "#72d3fe","#84d9ff","#98ddfc","#a9e5ff","#bbeaff",
  # "#80bf4d","#8eb15c","#a0c172", "#b1cf86", "#c1db9b", "#d2e6b5", "#d1eca8",
  # "#ffd58b", "#ffe37a", "#ffea61", "#fff192", "#fbffa1",
  # "#e36aa5", "#ea8b9f", "#f39fb1", "#fbafc0", "#f5c4d1", "#f5d3d8")) + guides(fill = guide_legend(ncol = 1))
  
  # legend <- get_legend(plot_leg)                     
  # grid.newpage()                               
  # grid.draw(legend)  
  # ggsave(file="legend.png",legend, width=22,height=21,units=c("cm"), dpi=600)
  # 
  ggplot(graph_d, aes(fill = Action, y = Proportion, x = Age)) +
  geom_bar(stat = "identity", position = "fill", lwd=0.01, width=.9, show.legend=FALSE) +  ylim(0,1) + ggtitle(name) +   theme_classic() +   ylab("Daily Activity Distribution") +
    xlab("Age (years)") + #scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7, 8, 9), labels=bin_labels) +
    scale_fill_manual(values = c("#8e7cc3",
  "#72d3fe","#84d9ff","#98ddfc","#a9e5ff","#bbeaff",
  "#80bf4d","#8eb15c","#a0c172", "#b1cf86", "#c1db9b", "#d2e6b5", "#d1eca8",
  "#ffd58b", "#ffe37a", "#ffea61", "#fff192", "#fbffa1",
  "#e36aa5", "#ea8b9f", "#f39fb1", "#fbafc0", "#f5c4d1", "#f5d3d8")) 
}

stacked_graph(subset(d, Name == "walimah"), name="Walimah")
stacked_graph(subset(d, Name == "berani"), name="Berani")
```
