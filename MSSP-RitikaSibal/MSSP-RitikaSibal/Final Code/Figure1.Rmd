---
title: "Figure1"
author: "Ritika"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# Change path to your local directory
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, comment = "##", prompt = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 75), fig.path = "Figure1 Images/")
```

## Load all the necessary libraries

``` {r librarys, echo = T, results = 'hide', message=FALSE, warnings=FALSE}
library(tidyverse)
library(magrittr) 
library(dplyr)  
library(vegan)
library(readxl)
library(effects)
library(ggeffects)
library(gridExtra)
library(ggstance)
library(MuMIn)
library(DHARMa)
library(sjPlot)
library(glmmTMB)
library(lme4)
library(kableExtra)
library(entropy)
```

## Preprocess Data

This is only done once to clean the data up from how it is exported in filemaker. Change to reflect your local library

``` {r preprocessing_data, echo = T, results = 'hide', message=FALSE, warnings=FALSE}
load_in_data_pre <- function(){
    d <- read_xlsx("../Locomotion Export 15 Feb 2024.xlsx",sheet = 1, guess_max = 1048576)
  d$Exclude <- d$Exclude %>% replace(is.na(.), 'a')
  # Remove the excluded data
  d <- subset(d, Exclude != 'E')
  
  #df <-d[c("Follow Number", "Name", "Minutes awake", "Age Class II lookup",	"Age class lookup" , "Mother Class", "Date")]
  df <-d[c("Follow Number", "Name", "Minutes awake", "Age",	"Age class lookup", 	"Age Class II lookup", "Date")]
  index_totalmin <- grepl('TotalM', colnames(d))
  
  df <- cbind(df, d[index_totalmin])
  df<- subset(df, `Minutes awake` >= 300)
  return(df)
}

df <- load_in_data_pre()

#library("writexl")
#write_xlsx(df,"~/Desktop/Knott-Lab-Research/OntogenyOfLocomotion/Ritika Excel Files/parsed-all.xlsx")
#write_xlsx(df,"~/Desktop/Knott-Lab-Research/OntogenyOfLocomotion/Ritika Excel Files/parsed-mother-infant.xlsx")
```

## Postprocess Data

This is run everytime. Make sure to change this path to your local directory

``` {r postprocessing_data}
load_in_data_post <- function(path, adult){
  d <- read_xlsx(path ,sheet = 1, guess_max = 1048576)
  
  d_cols <- read_xlsx(path,sheet = 2, guess_max = 1048576)
  d<- subset(d, `Minutes awake` >= 360)
  # Make NAs to Zeros
  d <- imputeTS::na_replace(d)
  # Make everything numeric
  d[8:ncol(d)] <- sapply(d[8:ncol(d)],as.numeric)
  
  if (adult){
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age", "Mother Class")]
      df$Age <- tolower(df$Age)
  } else {
      df <-d[c("Follow Number", "Name", "Minutes awake", "Age","Age class lookup", "Age Class II lookup")]
      df$`Age class lookup` <- tolower(df$`Age class lookup`)
       df$`Age Class II lookup` <- tolower(df$`Age Class II lookup`)
  }

  names(d) <- sub("PB ", "", names(d))
  names(d) <- sub(" TotalMinute", "", names(d))
  names(d) <- sub(" TotalMinutes", "", names(d))

  # Drop all the NAs
  df<-df[!is.na(df$`Follow Number`), ]
  df<-df[!is.na(df$Name), ]
  df<-df[!is.na(df$`Minutes awake`), ]
  
  # Do all the non-pooled
  for (col_name in d_cols$Nonpooled) {
    index <- grepl(col_name, colnames(d))
    df <- cbind(df, d[index])
  }
  
  # Do all the pooled categories
  for (idx in 1:length(na.omit(d_cols$Pooled))) {
    cat <- strsplit(d_cols$Categories[idx], "")
    for (jdx in 1:length(cat[[1]])) {
      string = paste(d_cols$Pooled[idx], cat[[1]][jdx], sep = "")
      index <- grepl(string, colnames(d))
      if (jdx == 1){
        pooled_min <- d[index]
      } else {
        pooled_min <- pooled_min + d[index]
      }
    }
    colnames(pooled_min)[1] <- paste(d_cols$Pooled[idx], d_cols$Categories[idx], sep="")
    df <- cbind(df, pooled_min)
  }
  
  # Normalize Data
  if(adult){
      df[,6:ncol(df)] <- df[,6:ncol(df)]/df$`Minutes awake`
      df <-df[rowSums(df[, 6:ncol(df)] > 1) == 0, ]
  } else{
      df[,7:ncol(df)] <- df[,7:ncol(df)]/df$`Minutes awake`
      df <-df[rowSums(df[, 7:ncol(df)] > 1) == 0, ]
  }
  
  # Change ages to binned categories
  if (adult) {
    df <- df %>% mutate(Age = case_when(
      # mothers with old children
      grepl('\\badult female\\b', Age) & (grepl('\\bOver\\b', `Mother Class`) |  grepl('\\<JUV\\>', `Mother Class`)) ~ 7)) # Over 4 years
    colnames(df)[5] <- "Age class lookup"
  } else{
    #df$Age = as.numeric(df$Age)
    df <- df %>% mutate(Age = case_when(
      Age >= 0  & Age < 2 ~ '1',
      Age >= 2  & Age < 4 ~ '2',
      Age >= 4  & Age < 6 ~ '3',
      Age >= 6  & Age < 8 ~ '4',
      Age >= 8  & Age < 10 ~ '5',
      Age >= 10  & Age < 12 ~ '6',
      # non mothers
      Age >= 12 & grepl('\\badult female\\b', `Age class lookup`) & grepl('\\bnon-mother\\b', `Age Class II lookup`) ~ '7',
      Age >= 12 & grepl ('\\bflanged male\\b', `Age class lookup`) ~ '7'))
    df <- df %>% select(-contains('Age Class II lookup'))
  }
  df<-df[!is.na(df$Age), ]
  df <- df %>% replace(is.na(.), 0)
  
  return(df)
}

d_juv <- load_in_data_post("../parsed-all.xlsx", adult=FALSE)

d_adult <- load_in_data_post("../parsed-mother-infant.xlsx", adult=TRUE) # no values in adult

d <- rbind(d_juv, d_adult)
d <- d %>% distinct(`Follow Number`, .keep_all = TRUE)

# Just to clean up
# rm(d_juv, d_adult)

#library("writexl")
#write_xlsx(d,"~/Desktop/W24/Research/OntogenyOfLocomotion/all-juve-adult_female_.xlsx")
```
```{r}
length(unique(d$Name))
# write.csv(d, "../final_data.csv")
```

## Calculate Diversity

This is all done using the default shannon-weaver index, but you can change it to simpson or invsimpson

``` {r diversity_calculations}
calculateDiversisty <- function(d){
  metric_d <- d
  metric_d$Name <- tolower(metric_d$Name)
  
  act_colnames <- unique(colnames(metric_d[,6:ncol(metric_d)]))
  
  dive_d <- data.frame(FollowNumber=integer(),
                       Name=character(),
                       Age=integer(),
                      DiversityScore=integer())
  
  
  for (j in unique(metric_d$Name)){
    name <- metric_d[grepl(j, metric_d$Name, ignore.case = TRUE),]
    for (y in unique(name$`Follow Number`)){
        follow <- subset(name, `Follow Number` == y)
        for (i in min(follow$Age):max(follow$Age)){
          age <- subset(follow, Age == i)
          row_values <- c()
          for (x in act_colnames) {
            act_col <- sum(age[, c(x) ])
            row_values <- append(row_values, act_col)
          }
          div <- diversity(row_values)
          if (div > 0){
            dive_d[nrow(dive_d) + 1,] <- c(y, j, i, div)
            rm(row_values)
          }
        }
    }
  }
  return(dive_d)
}

dive_d <- calculateDiversisty(d)
dive_d$DiversityScore <- as.numeric(dive_d$DiversityScore)

# For InvSimpson
#dive_d$DiversityScore[is.infinite(dive_d$DiversityScore)] <- max(dive_d$DiversityScore[!is.infinite(dive_d$DiversityScore)], na.rm = TRUE)
```
```{r}
glimpse(dive_d)
# write.csv(dive_d, "../diversity_score.csv")
```

## GLMM Analysis

Gaussian with log link chosen

``` {r glmm analysis_adult}
dive_d$DiversityScore <- as.numeric(dive_d$DiversityScore)

#visualize distribution of diversity scores
ggplot() + 
  geom_jitter(data=dive_d, aes(x=Age, y=DiversityScore), color = "pink",size = 0.75, shape = 1) + 
  geom_boxplot(data=dive_d, aes(x=Age, y=DiversityScore), fill = "pink", color="red", alpha = 0.6) +
  theme_classic() + 
  scale_x_discrete(breaks=c(1, 2, 3, 4, 5, 6, 7), labels=c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults"))  

dive_d$Age <- as.numeric(dive_d$Age)
# Just visualise the data
hist(dive_d$DiversityScore)
hist(dive_d$Age, breaks=0:7)



# Do the actual glmms
model.1 <- glmmTMB(data=dive_d, DiversityScore ~  (1|Name) + (1|FollowNumber), family=gaussian(link="log"))
summary_df <- data.frame(Model_Type=c('Gaussian Log No F.E.'), AIC=summary(model.1)$AIC[1], BIC=summary(model.1)$AIC[2])

model.2 <- glmmTMB(data=dive_d, DiversityScore ~ Age + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
summary_df[nrow(summary_df) + 1,] = c('Gaussian Log', summary(model.2)$AIC[1], summary(model.2)$AIC[2])

model.3 <- glmmTMB(data=dive_d, DiversityScore ~ Age + I(Age^2) + (1|Name)+ (1|FollowNumber), family=gaussian(link="log"))
summary_df[nrow(summary_df) + 1,] = c('Gaussian Log Age^2', summary(model.3)$AIC[1], summary(model.3)$AIC[2])

#plot.new()
#grid.table(summary_df)

model <- model.3
```

## Analyse the GLMM

```{r analyse_glmm_model_adult, eval=FALSE}
# Test that adding age actually made the model better
anova(model.1,model.2)
anova(model.2,model.3)

# Now look at the actual model
sim_res <- simulateResiduals(model, 250, quantreg=T)
testDispersion(model)
testDispersion(model, type="PearsonChisq", alternative="greater")
testUniformity(model) 
plotResiduals(sim_res)


set_theme(base = theme_classic(), #To remove the background color and the grids
          theme.font = 'serif',   #To change the font type
          axis.title.size = 1.0,  #To change axis title size
          axis.textsize.x = 1.0,  #To change x axis text size
          axis.textsize.y = 1.0)  #To change y axis text size


plot_model(model, show.values = TRUE, title = "Estimates of fixed effects", vline.color = "grey")

confint(model) # make sure the confints dont cross 0
r.squaredGLMM(model_M)
```

## Plot the GLMM

Here we plot the GLMM predictions with the original data

``` {r plotting_model_adult}
r2 <- round(r.squaredGLMM(model)[[1]], digits = 2)

bin_labels <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")

# This is the predicted data using the GLMM and with all terms
df <- ggpredict(model, terms="Age [all]") 

ggplot(df,aes(x, predicted)) + theme_classic() + 
  geom_point(data=dive_d, aes(x=Age, y=DiversityScore), alpha=0.1, size=1.5, color="#92a8d1") + geom_line(aes(linetype=group, color=group), color="#003366") +
    geom_ribbon(aes(ymin=conf.low, ymax=conf.high, fill=group), alpha=0.15, fill="#003366") +
  ylab("Positional Behavior Diversity Score")  +
  xlab("Age (years)") +
  ggtitle("Ontogeny of Positional Behavior") + theme(legend.position = "none") + scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7), labels=bin_labels)  + theme(axis.text=element_text(size=7), axis.text.x = element_text(size=7), axis.title.y = element_text(size=8), title = element_text(size=9)) + coord_fixed(ratio = 2) #+  geom_text(aes(label=x),data=df[which.max(df$predicted),], hjust=1.2, vjust=3)
```

## Plot the stacked barplots

Everything has been scaled to equal 1 (for the day)
``` {r stacked_adult}
# Reset the data by loading the original dataframe
metric_d <- d

graph_d <- data.frame(Age=integer(), Action=character(), Proportion=integer())

for (i in 1:nrow(metric_d)){
    for(j in colnames(metric_d[6:ncol(metric_d)])){
      if(metric_d[j][i,1] != 0){
        graph_d[nrow(graph_d) + 1,] <- c(metric_d$Age[i], j, metric_d[j][i,1])
      }
    }
}

## Plotting Stacked Bargraph

graph_d$Proportion = as.numeric(graph_d$Proportion)
graph_d$Age = as.numeric(graph_d$Age)

# Get the mean of each activity 
graph_d <- aggregate(Proportion ~ Age + Action , FUN = mean, data=graph_d)

for(x in 1:length(graph_d$Action)){
  graph_d$Action[x] <- paste(unlist(strsplit(graph_d$Action[x], "(?<=[a-z])(?=[A-Z])", perl = TRUE)[[1]][1:2]), collapse="")
}

graph_d <- graph_d[,order(colnames(graph_d))]

bin_labels <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults", "Flanged Male", "Unflanged Male")

# This is just done once to save the legend in a nice image
# plot_leg <- ggplot(graph_d, aes(fill = Action, y = Proportion, x = Age)) + geom_bar(stat = "identity", position = "stack")+ scale_fill_manual(values = c("#8e7cc3",
# "#72d3fe","#84d9ff","#98ddfc","#a9e5ff","#bbeaff",
# "#80bf4d","#8eb15c","#a0c172", "#b1cf86", "#c1db9b", "#d2e6b5", "#d1eca8",
# "#ffd58b", "#ffe37a", "#ffea61", "#fff192", "#fbffa1",
# "#e36aa5", "#ea8b9f", "#f39fb1", "#fbafc0", "#f5c4d1", "#f5d3d8")) + guides(fill = guide_legend(ncol = 1))
# 
# library( ggpubr )
# library("grid") 
# library("gridExtra") 
# library("cowplot") 
# legend <- get_legend(plot_leg)                     
# grid.newpage()                               
# grid.draw(legend)  
# ggsave(file="legend.png",legend, width=22,height=21,units=c("cm"), dpi=600)

# Remove ages 10-12 since we only have females
graph_d <- graph_d[graph_d$Age != 6, ]

ggplot(graph_d, aes(fill = Action, y = Proportion, x = Age)) +
geom_bar(stat = "identity", position = "fill", lwd=0.01, width=.9, show.legend = FALSE) +  ylim(0,1) + ggtitle("Distribution of Activity with Age") +   theme_classic() +   ylab("Daily Activity Distribution") +
  xlab("Age (years)") + scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7, 8, 9), labels=bin_labels) + scale_fill_manual(values = c("#8e7cc3",
"#72d3fe","#84d9ff","#98ddfc","#a9e5ff","#bbeaff",
"#80bf4d","#8eb15c","#a0c172", "#b1cf86", "#c1db9b", "#d2e6b5", "#d1eca8",
"#ffd58b", "#ffe37a", "#ffea61", "#fff192", "#fbffa1",
"#e36aa5", "#ea8b9f", "#f39fb1", "#fbafc0", "#f5c4d1", "#f5d3d8")) 

```
Done!

## Supplemental Figures

```{r gstat_matrix}
gstat_matrix <- function(d){
  d=graph_d
  #Act = 'Travel'
  age_groups <- unique(d$Age)
  p_matrix <- matrix(nrow = length(age_groups), ncol = length(age_groups))
  rownames(p_matrix) <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")
  colnames(p_matrix) <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")
  # Loop over pairs and perform t-tests
  for(i in age_groups){
    subset_age_a <- d[d$Age==i,2:ncol(d)]
    subset_age_a <- as.numeric(subset_age_a/rowSums(subset_age_a))
    print(diversity(subset_age_a))
    for (j in age_groups){
          subset_age_b <- d[d$Age==j,2:ncol(d)]
          subset_age_b <- as.numeric(subset_age_b/rowSums(subset_age_b))
          g_stat_result <- Gstat(subset_age_a, subset_age_b)
          if(g_stat_result[[3]]< 0.001){
              p_matrix[i, j] = "***"
              p_matrix[j, i] = "***"
          } else{
              p_matrix[i, j] = "ns"
              p_matrix[j, i] = "ns"
          }

    }
  }

    return(p_matrix)
}

graph_d <- aggregate(d[6:ncol(d)], by=d[4],  FUN = mean)

graph_d <- mutate_all(graph_d, function(x) as.numeric(as.character(x)))
graph_d <- graph_d %>% select_if(colSums(.) != 0)

p_matrix <- gstat_matrix(graph_d)
kable(p_matrix) %>% kable_styling(latex_options = "striped")

```

``` {r mean_diversity_figure}
mean_diversity <- function(d){
  d=graph_d
  #Act = 'Travel'
  age_groups <- unique(d$Age)
  rownames(p_matrix) <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")
  colnames(p_matrix) <- c("0-2", "2-4", "4-6", "6-8", "8-10", "10-12", "Adults")
  age_div_scores <- c()
  # Loop over pairs and perform t-tests
  for(i in age_groups){
    subset_age_a <- d[d$Age==i,2:ncol(d)]
    subset_age_a <- as.numeric(subset_age_a/rowSums(subset_age_a))
    age_div_scores[i]=diversity(subset_age_a)
  }

    return(age_div_scores)
}

mean_div <- mean_diversity(graph_d)
plot(mean_div)
```